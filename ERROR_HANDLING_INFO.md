# ‚ö†Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ Telegram API

## "Query is too old" –æ—à–∏–±–∫–∞

### –ß—Ç–æ —ç—Ç–æ?

–≠—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ Telegram API, –∫–æ—Ç–æ—Ä–∞—è –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –∫–æ–≥–¥–∞ –±–æ—Ç –ø—ã—Ç–∞–µ—Ç—Å—è –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ callback query, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ —É—Å—Ç–∞—Ä–µ–ª (–ø—Ä–æ—à–ª–æ –±–æ–ª—å—à–µ 60 —Å–µ–∫—É–Ω–¥).

```
TelegramBadRequest: Telegram server says - Bad Request: query is too old and response timeout expired or query ID is invalid
```

### –ü—Ä–∏—á–∏–Ω—ã:

1. **–ú–µ–¥–ª–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É, –Ω–æ –æ—Ç–≤–µ—Ç –ø—Ä–∏—à—ë–ª —Å–ª–∏—à–∫–æ–º –ø–æ–∑–¥–Ω–æ
2. **–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –±–æ—Ç–∞** - callback –±—ã–ª —Å–æ–∑–¥–∞–Ω –¥–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏, –∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –ø–æ—Å–ª–µ
3. **–î–æ–ª–≥–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–ø–æ–ª–Ω—è–ª—Å—è –¥–æ–ª—å—à–µ 60 —Å–µ–∫—É–Ω–¥
4. **–ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –Ω–∞–∂–∞–ª –Ω–∞ –æ–¥–Ω—É –∫–Ω–æ–ø–∫—É

### –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ?

**–ù–µ—Ç!** –≠—Ç–æ –Ω–µ –æ—à–∏–±–∫–∞ –≤ –∫–æ–¥–µ. –ü—Ä–æ—Å—Ç–æ Telegram –Ω–µ –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.

### –ö–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ:

#### –í–∞—Ä–∏–∞–Ω—Ç 1: Try-catch –Ω–∞ –∫–∞–∂–¥—ã–π callback.answer()

```python
try:
    await callback.answer('–û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω!')
except TelegramBadRequest:
    pass  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É "query too old"
```

#### –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é

```python
from utils.telegram_helpers import safe_answer_callback

# –í–º–µ—Å—Ç–æ:
await callback.answer('–û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω!')

# –ò—Å–ø–æ–ª—å–∑—É–µ–º:
await safe_answer_callback(callback, '–û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω!')
```

### –ì–¥–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞:

1. ‚úÖ `handlers/interview_handlers.py` - –≤—Å–µ callback.answer()
2. ‚úÖ `handlers/admin_handlers.py` - handle_reserv_answer (—Å—Ç—Ä–æ–∫–∞ 829)
3. ‚úÖ `utils/telegram_helpers.py` - –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è

### –î—Ä—É–≥–∏–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏:

#### "Message is not modified"

–í–æ–∑–Ω–∏–∫–∞–µ—Ç –∫–æ–≥–¥–∞ –ø—ã—Ç–∞–µ–º—Å—è –∏–∑–º–µ–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —Ç–æ—á–Ω–æ —Ç–∞–∫–æ–µ –∂–µ.

**–†–µ—à–µ–Ω–∏–µ:**
```python
try:
    await message.edit_text(new_text)
except TelegramBadRequest as e:
    if "message is not modified" in str(e).lower():
        pass  # –°–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ —Ç–∞–∫–æ–µ
    else:
        raise
```

#### "Message to edit not found"

–°–æ–æ–±—â–µ–Ω–∏–µ –±—ã–ª–æ —É–¥–∞–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.

**–†–µ—à–µ–Ω–∏–µ:**
```python
try:
    await callback.message.edit_text(text)
except TelegramBadRequest as e:
    if "message to edit not found" in str(e).lower():
        # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        await callback.message.answer(text)
    else:
        raise
```

#### "Message can't be deleted"

–°–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ —É–¥–∞–ª–µ–Ω–æ –∏–ª–∏ –ø—Ä–æ—à–ª–æ 48 —á–∞—Å–æ–≤.

**–†–µ—à–µ–Ω–∏–µ:**
```python
try:
    await message.delete()
except TelegramBadRequest:
    pass  # –£–∂–µ —É–¥–∞–ª–µ–Ω–æ –∏–ª–∏ –Ω–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å
```

---

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–í—Å–µ–≥–¥–∞ –æ–±–æ—Ä–∞—á–∏–≤–∞–π—Ç–µ callback.answer()** –≤ try-except
2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `safe_answer_callback()`** –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã –∫–æ–¥–∞
3. **–ù–µ –ª–æ–≥–∏—Ä—É–π—Ç–µ —ç—Ç—É –æ—à–∏–±–∫—É** - –æ–Ω–∞ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–∞
4. **–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å** –¥–∞–∂–µ –µ—Å–ª–∏ callback.answer() –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª

---

## ‚úÖ –ò—Ç–æ–≥

–û—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ! –û–Ω–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏ –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É –±–æ—Ç–∞. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å—Ç–æ –Ω–µ —É–≤–∏–¥–∏—Ç –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –Ω–æ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ.

