# üêõ –û—Ç–ª–∞–¥–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ–º —Å–ª–æ—Ç–æ–≤

## üìä –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ—Å–ª–µ –æ—Ç–º–µ–Ω—ã –∑–∞–ø–∏—Å–∏ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ (–∫–Ω–æ–ø–∫–∞ "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å") —Å–ª–æ—Ç –Ω–µ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è –∏ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è —Å–Ω–æ–≤–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –æ—à–∏–±–∫–∞:
```
duplicate key value violates unique constraint "interviews_time_slot_id_key"
```

## üîç –ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ

–î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö:

### 1. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–∏:
```python
print(f"üîí –ë–ª–æ–∫–∏—Ä—É—é —Å–ª–æ—Ç {slot.id}: is_available={slot.is_available} -> False")
slot.is_available = False
# ... commit ...
print(f"‚úÖ –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞, slot_id={slot.id}, interview_id={interview.id}")
```

### 2. –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–ø–∏—Å–∏:
```python
print(f"üîì –û—Å–≤–æ–±–æ–∂–¥–∞—é —Å–ª–æ—Ç {slot.id}: is_available={slot.is_available} -> True")
slot.is_available = True
# ... commit ...
print(f"‚úÖ –û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏ {interview.id} –∑–∞–≤–µ—Ä—à–µ–Ω–∞, —Å–ª–æ—Ç {interview.time_slot_id} –æ—Å–≤–æ–±–æ–∂–¥—ë–Ω")
```

### 3. –ï—Å–ª–∏ —Å–ª–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω:
```python
print(f"‚ö†Ô∏è –°–ª–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è interview {interview.id}, time_slot_id={interview.time_slot_id}")
```

## üöÄ –ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### –®–∞–≥ 1: –ó–∞–¥–µ–ø–ª–æ–∏—Ç—å –∫–æ–¥ —Å –ª–æ–≥–∞–º–∏
```bash
# –ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ
cd "C:\Users\anato\OneDrive\–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª\ShaBot"
git add handlers/interview_handlers.py
git commit -m "debug: –¥–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ —Å–ª–æ—Ç–æ–≤"
git push origin main

# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
ssh root@sha
cd ~/Shend
git pull origin main
docker-compose restart bot
```

### –®–∞–≥ 2: –û—á–∏—Å—Ç–∏—Ç—å –ë–î (–Ω–∞—á–∞—Ç—å —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞)
```bash
echo "
DELETE FROM interview_messages;
DELETE FROM interviews;
UPDATE time_slots SET is_available = true;
SELECT COUNT(*) as free_slots FROM time_slots WHERE is_available = true;
SELECT COUNT(*) as interviews FROM interviews;
" | docker exec -i shend-db-1 psql -U postgres -d shabot_db
```

### –®–∞–≥ 3: –¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
```
1. –û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞
2. /sobes ‚Üí –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–ª–æ—Ç
3. –°–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å: üîí –ë–ª–æ–∫–∏—Ä—É—é —Å–ª–æ—Ç ...)
4. –ù–∞–∂–∞—Ç—å "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å"
5. –°–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å: üîì –û—Å–≤–æ–±–æ–∂–¥–∞—é —Å–ª–æ—Ç ...)
6. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å–∞—Ç—å—Å—è —Å–Ω–æ–≤–∞ –Ω–∞ —Ç–æ—Ç –∂–µ —Å–ª–æ—Ç
7. –î–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –æ—à–∏–±–æ–∫!
```

### –®–∞–≥ 4: –°–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
```bash
docker logs shend-bot-1 -f
```

–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏:
```
üîí –ë–ª–æ–∫–∏—Ä—É—é —Å–ª–æ—Ç 134: is_available=True -> False
‚úÖ –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞, slot_id=134, interview_id=123
üîì –û—Å–≤–æ–±–æ–∂–¥–∞—é —Å–ª–æ—Ç 134: is_available=False -> True
‚úÖ –û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏ 123 –∑–∞–≤–µ—Ä—à–µ–Ω–∞, —Å–ª–æ—Ç 134 –æ—Å–≤–æ–±–æ–∂–¥—ë–Ω
üîí –ë–ª–æ–∫–∏—Ä—É—é —Å–ª–æ—Ç 134: is_available=True -> False
‚úÖ –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞, slot_id=134, interview_id=124
```

## üîç –ß—Ç–æ –∏—Å–∫–∞—Ç—å –≤ –ª–æ–≥–∞—Ö

### ‚úÖ –ù–æ—Ä–º–∞–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:
```
üîí –ë–ª–æ–∫–∏—Ä—É—é —Å–ª–æ—Ç X: is_available=True -> False
‚úÖ –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞
üîì –û—Å–≤–æ–±–æ–∂–¥–∞—é —Å–ª–æ—Ç X: is_available=False -> True
‚úÖ –û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
```

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ #1: –°–ª–æ—Ç —É–∂–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
```
üîí –ë–ª–æ–∫–∏—Ä—É—é —Å–ª–æ—Ç X: is_available=False -> False  ‚Üê –ü—Ä–æ–±–ª–µ–º–∞!
```
–≠—Ç–æ –∑–Ω–∞—á–∏—Ç —á—Ç–æ `is_available` —É–∂–µ –±—ã–ª `False` –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–ø–∏—Å–∏.

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ #2: –°–ª–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω
```
‚ö†Ô∏è –°–ª–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è interview Y, time_slot_id=X
```
–≠—Ç–æ –∑–Ω–∞—á–∏—Ç —á—Ç–æ —Å–ª–æ—Ç –±—ã–ª —É–¥–∞–ª—ë–Ω –∏–∑ –ë–î –∏–ª–∏ `time_slot_id` –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω.

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ #3: Commit –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
–ï—Å–ª–∏ –≤—ã –≤–∏–¥–∏—Ç–µ:
```
üîì –û—Å–≤–æ–±–æ–∂–¥–∞—é —Å–ª–æ—Ç X: is_available=False -> True
```
–ù–æ –ù–ï –≤–∏–¥–∏—Ç–µ:
```
‚úÖ –û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
```
–ó–Ω–∞—á–∏—Ç `commit()` —É–ø–∞–ª —Å –æ—à–∏–±–∫–æ–π. –°–º–æ—Ç—Ä–∏—Ç–µ —Å–ª–µ–¥ —Å—Ç—Ä–æ–∫–∏ –≤ –ª–æ–≥–∞—Ö –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Ç—Ä–µ–π—Å–±–µ–∫–∞.

## üìä SQL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ë–î

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–ª–æ—Ç:
```sql
-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ª–æ—Ç –∏ –≤—Å–µ –∑–∞–ø–∏—Å–∏ –Ω–∞ –Ω–µ–≥–æ
SELECT 
    ts.id as slot_id,
    ts.is_available,
    ts.date,
    ts.time_start,
    i.id as interview_id,
    i.status as interview_status,
    i.created_at
FROM time_slots ts
LEFT JOIN interviews i ON i.time_slot_id = ts.id
WHERE ts.id = 134  -- –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –Ω—É–∂–Ω—ã–π —Å–ª–æ—Ç
ORDER BY i.created_at DESC;
```

### –ù–∞–π—Ç–∏ –≤—Å–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è:
```sql
-- –°–ª–æ—Ç—ã –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ —Å–≤–æ–±–æ–¥–Ω—ã–µ, –Ω–æ –Ω–∞ –Ω–∏—Ö –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –∑–∞–ø–∏—Å—å
SELECT 
    ts.id,
    ts.is_available,
    i.id as interview_id,
    i.status
FROM time_slots ts
JOIN interviews i ON i.time_slot_id = ts.id
WHERE ts.is_available = true
AND i.status IN ('confirmed', 'pending');
```

## üîß –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–µ—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è)

–ï—Å–ª–∏ –ø–æ—Å–ª–µ –æ—Ç–º–µ–Ω—ã –∑–∞–ø–∏—Å–∏ —Å–ª–æ—Ç –Ω–µ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è:

```sql
-- –í—Ä—É—á–Ω—É—é –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–ª–æ—Ç
UPDATE time_slots 
SET is_available = true 
WHERE id = 134;  -- –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –Ω—É–∂–Ω—ã–π ID

-- –ò–ª–∏ –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –≤—Å–µ —Å–ª–æ—Ç—ã –±–µ–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
UPDATE time_slots
SET is_available = true
WHERE id IN (
    SELECT DISTINCT ts.id
    FROM time_slots ts
    LEFT JOIN interviews i ON i.time_slot_id = ts.id AND i.status IN ('confirmed', 'pending')
    WHERE ts.is_available = false AND i.id IS NULL
);
```

## üìù –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã

1. **Exception –ø—Ä–∏ commit** - —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è
2. **–°–ª–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω** - `time_slot_id` –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
3. **Race condition** - (—É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ `FOR UPDATE`)
4. **–†—É—á–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –ë–î** - —É–¥–∞–ª–µ–Ω–∏–µ interview –±–µ–∑ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è —Å–ª–æ—Ç–∞

## ‚úÖ –ü–æ—Å–ª–µ –æ—Ç–ª–∞–¥–∫–∏

–ö–æ–≥–¥–∞ –Ω–∞–π–¥—ë–º –ø—Ä–∏—á–∏–Ω—É –∏ –∏—Å–ø—Ä–∞–≤–∏–º, **—É–¥–∞–ª–∏—Ç—å –ª–æ–≥–∏** –∏–∑ –ø—Ä–æ–¥–∞–∫—à–µ–Ω-–∫–æ–¥–∞:

```python
# –£–±—Ä–∞—Ç—å –≤—Å–µ print() –∏–∑ handlers/interview_handlers.py
```

---

**–ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!** üöÄ

–ó–∞–ø—É—Å—Ç–∏ –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –∏ –ø—Ä–∏—à–ª–∏ –ª–æ–≥–∏ - —Ä–∞–∑–±–µ—Ä—ë–º—Å—è —á—Ç–æ –Ω–µ —Ç–∞–∫! üîç

