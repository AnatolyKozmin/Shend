# üêõ FIX: –ü—Ä–æ–±–ª–µ–º–∞ —Å UNIQUE constraint –Ω–∞ time_slot_id

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ—Å–ª–µ –æ—Ç–º–µ–Ω—ã –∑–∞–ø–∏—Å–∏ –∏ –ø–æ–ø—ã—Ç–∫–∏ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è —Å–Ω–æ–≤–∞ –Ω–∞ —Ç–æ—Ç –∂–µ —Å–ª–æ—Ç:
```
duplicate key value violates unique constraint "interviews_time_slot_id_key"
Key (time_slot_id)=(193) already exists.
```

## üîç –ü—Ä–∏—á–∏–Ω–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã `interviews`:
```sql
CREATE TABLE interviews (
    id SERIAL PRIMARY KEY,
    time_slot_id INTEGER UNIQUE,  ‚Üê –í–û–¢ –û–ù–ê, –ü–†–û–ë–õ–ï–ú–ê!
    interviewer_id INTEGER,
    status VARCHAR(20) DEFAULT 'pending',
    ...
);
```

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è ‚Üí —Å–æ–∑–¥–∞—ë—Ç—Å—è `Interview` —Å `time_slot_id=193`, `status='confirmed'`
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω—è–µ—Ç ‚Üí `Interview.status` –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `'cancelled'` (–∑–∞–ø–∏—Å—å **–ù–ï —É–¥–∞–ª—è–µ—Ç—Å—è**)
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å–∞—Ç—å—Å—è —Å–Ω–æ–≤–∞ ‚Üí –ø–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞—Ç—å **–Ω–æ–≤—É—é** `Interview` —Å `time_slot_id=193`
4. ‚ùå **–û–®–ò–ë–ö–ê**: `UNIQUE constraint` –Ω–∞ `time_slot_id` –Ω–∞—Ä—É—à–µ–Ω!

### –ü–æ—á–µ–º—É –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –ø–æ–º–æ–≥–ª–∞:
```python
# –ú—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø–∏—Å–∏:
existing = select(Interview).where(
    time_slot_id == 193,
    status IN ('confirmed', 'pending')  ‚Üê –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç!
)
```

–ù–æ –≤ –ë–î –≤–∏—Å–∏—Ç **–æ—Ç–º–µ–Ω—ë–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å** —Å `status='cancelled'` –∏ `time_slot_id=193`, –∫–æ—Ç–æ—Ä–∞—è –Ω–∞—Ä—É—à–∞–µ—Ç UNIQUE!

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ: –£–¥–∞–ª—è—Ç—å –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–π

### –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:
```python
# –î–û–ë–ê–í–õ–ï–ù–û –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏:

# –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –Ω–∞ —ç—Ç–æ—Ç —Å–ª–æ—Ç
cancelled_interviews = select(Interview).where(
    Interview.time_slot_id == selected_slot_id,
    Interview.status == 'cancelled'
).all()

for cancelled in cancelled_interviews:
    print(f"üóëÔ∏è –£–¥–∞–ª—è—é –æ—Ç–º–µ–Ω—ë–Ω–Ω—É—é –∑–∞–ø–∏—Å—å {cancelled.id}")
    session.delete(cancelled)

if cancelled_interviews:
    await session.flush()  # –ü—Ä–∏–º–µ–Ω—è–µ–º —É–¥–∞–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π

# –¢–ï–ü–ï–†–¨ –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
interview = Interview(time_slot_id=selected_slot_id, ...)
```

### –ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. **–£–¥–∞–ª—è–µ–º –≤—Å–µ –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏** –Ω–∞ —ç—Ç–æ—Ç —Å–ª–æ—Ç
2. **Flush** –ø—Ä–∏–º–µ–Ω—è–µ—Ç —É–¥–∞–ª–µ–Ω–∏–µ –≤ —Ä–∞–º–∫–∞—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
3. **–°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å** - —Ç–µ–ø–µ—Ä—å UNIQUE constraint –Ω–µ –Ω–∞—Ä—É—à–µ–Ω
4. **Commit** —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å—ë –∞—Ç–æ–º–∞—Ä–Ω–æ

---

## üéØ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º)

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ò–∑–º–µ–Ω–∏—Ç—å UNIQUE constraint
```sql
-- –£–±—Ä–∞—Ç—å —Å—Ç–∞—Ä—ã–π constraint
ALTER TABLE interviews DROP CONSTRAINT interviews_time_slot_id_key;

-- –î–æ–±–∞–≤–∏—Ç—å partial UNIQUE index
CREATE UNIQUE INDEX interviews_time_slot_id_active_idx 
ON interviews (time_slot_id) 
WHERE status IN ('confirmed', 'pending');
```

**–ú–∏–Ω—É—Å—ã:** –ù—É–∂–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è, –º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ.

### –í–∞—Ä–∏–∞–Ω—Ç 2: –í—Å–µ–≥–¥–∞ —É–¥–∞–ª—è—Ç—å –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ
```python
# –í cancel_interview_callback:
session.delete(interview)  # –≤–º–µ—Å—Ç–æ interview.status = 'cancelled'
```

**–ú–∏–Ω—É—Å—ã:** –¢–µ—Ä—è–µ–º –∏—Å—Ç–æ—Ä–∏—é, –Ω–µ–ª—å–∑—è –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫—Ç–æ –æ—Ç–º–µ–Ω—è–ª.

### –í–∞—Ä–∏–∞–Ω—Ç 3: –£–±—Ä–∞—Ç—å UNIQUE constraint —Å–æ–≤—Å–µ–º
```sql
ALTER TABLE interviews DROP CONSTRAINT interviews_time_slot_id_key;
```

**–ú–∏–Ω—É—Å—ã:** –ú–æ–∂–Ω–æ —Å–ª—É—á–∞–π–Ω–æ —Å–æ–∑–¥–∞—Ç—å –¥—É–±–ª–∏, –Ω—É–∂–Ω–∞ –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–æ–∫.

---

## üìä –ö–∞–∫ —ç—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –≤ –ª–æ–≥–∞—Ö

### –î–æ fix:
```
SELECT ... WHERE status IN ('confirmed', 'pending')  ‚Üê –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à—ë–ª
üîí –ë–ª–æ–∫–∏—Ä—É—é —Å–ª–æ—Ç 193
INSERT INTO interviews ...
‚ùå duplicate key ... (193) already exists  ‚Üê –û–®–ò–ë–ö–ê!
ROLLBACK
```

### –ü–æ—Å–ª–µ fix:
```
SELECT ... WHERE status IN ('confirmed', 'pending')  ‚Üê –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à—ë–ª
SELECT ... WHERE status = 'cancelled'                ‚Üê –ù–∞—à—ë–ª —Å—Ç–∞—Ä—É—é –∑–∞–ø–∏—Å—å!
üóëÔ∏è –£–¥–∞–ª—è—é –æ—Ç–º–µ–Ω—ë–Ω–Ω—É—é –∑–∞–ø–∏—Å—å 123
FLUSH (—É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–∏–ª–æ—Å—å)
üîí –ë–ª–æ–∫–∏—Ä—É—é —Å–ª–æ—Ç 193
INSERT INTO interviews ...                           ‚Üê –£—Å–ø–µ—à–Ω–æ!
‚úÖ –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞
COMMIT
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ó–∞–ø–∏—Å—å ‚Üí –û—Ç–º–µ–Ω–∞ ‚Üí –ó–∞–ø–∏—Å—å —Å–Ω–æ–≤–∞
```
1. /sobes ‚Üí –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–ª–æ—Ç 193
   –û–∂–∏–¥–∞–µ–º–æ: ‚úÖ –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞, interview_id=100

2. –ù–∞–∂–∞—Ç—å "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å"
   –û–∂–∏–¥–∞–µ–º–æ: ‚úÖ –û—Ç–º–µ–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, —Å–ª–æ—Ç –æ—Å–≤–æ–±–æ–∂–¥—ë–Ω
   –í –ë–î: Interview(id=100, status='cancelled', time_slot_id=193)

3. /sobes ‚Üí –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Ç–æ—Ç –∂–µ —Å–ª–æ—Ç 193
   –û–∂–∏–¥–∞–µ–º–æ: 
   - üóëÔ∏è –£–¥–∞–ª—è—é –æ—Ç–º–µ–Ω—ë–Ω–Ω—É—é –∑–∞–ø–∏—Å—å 100
   - ‚úÖ –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞, interview_id=101
   –í –ë–î: Interview(id=101, status='confirmed', time_slot_id=193)
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ù–µ—Å–∫–æ–ª—å–∫–æ –æ—Ç–º–µ–Ω –Ω–∞ –æ–¥–∏–Ω —Å–ª–æ—Ç
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A –∑–∞–ø–∏—Å–∞–ª—Å—è ‚Üí –æ—Ç–º–µ–Ω–∏–ª
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å B –∑–∞–ø–∏—Å–∞–ª—Å—è ‚Üí –æ—Ç–º–µ–Ω–∏–ª
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å C –∑–∞–ø–∏—Å–∞–ª—Å—è ‚Üí –æ—Ç–º–µ–Ω–∏–ª

–í –ë–î: 3 –∑–∞–ø–∏—Å–∏ —Å–æ status='cancelled' –Ω–∞ slot 193

4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å D –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å–∞—Ç—å—Å—è
   –û–∂–∏–¥–∞–µ–º–æ:
   - üóëÔ∏è –£–¥–∞–ª—è—é –æ—Ç–º–µ–Ω—ë–Ω–Ω—É—é –∑–∞–ø–∏—Å—å (A)
   - üóëÔ∏è –£–¥–∞–ª—è—é –æ—Ç–º–µ–Ω—ë–Ω–Ω—É—é –∑–∞–ø–∏—Å—å (B)
   - üóëÔ∏è –£–¥–∞–ª—è—é –æ—Ç–º–µ–Ω—ë–Ω–Ω—É—é –∑–∞–ø–∏—Å—å (C)
   - ‚úÖ –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞ –¥–ª—è D
```

---

## üìù SQL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

### –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–ª–æ—Ç:
```sql
SELECT 
    id,
    time_slot_id,
    status,
    bot_user_id,
    created_at,
    cancelled_at
FROM interviews
WHERE time_slot_id = 193
ORDER BY created_at DESC;
```

### –ù–∞–π—Ç–∏ —Å–ª–æ—Ç—ã —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∑–∞–ø–∏—Å—è–º–∏:
```sql
SELECT 
    time_slot_id,
    COUNT(*) as count,
    STRING_AGG(status, ', ') as statuses
FROM interviews
GROUP BY time_slot_id
HAVING COUNT(*) > 1
ORDER BY count DESC;
```

### –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ):
```sql
DELETE FROM interviews WHERE status = 'cancelled';
```

---

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—à–µ–Ω–∏—è

1. **–ù–µ –Ω—É–∂–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è** - —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ç–µ–∫—É—â–µ–π —Å—Ö–µ–º–æ–π –ë–î
2. **–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å** - –≤—Å—ë –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
3. **–õ–æ–≥–∏** - –≤–∏–¥–Ω–æ –∫–æ–≥–¥–∞ –∏ —á—Ç–æ —É–¥–∞–ª—è–µ—Ç—Å—è
4. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - —É–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏
5. **–ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è** - –ø–æ–∫–∞ –∑–∞–ø–∏—Å—å –∞–∫—Ç–∏–≤–Ω–∞, –æ–Ω–∞ –≤ –ë–î

---

## üöÄ –î–µ–ø–ª–æ–π

```bash
# –ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ
git add handlers/interview_handlers.py
git commit -m "fix: —É–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–π (UNIQUE constraint)"
git push origin main

# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
ssh root@sha
cd ~/Shend
git pull origin main
docker-compose restart bot

# –¢–µ—Å—Ç
/sobes ‚Üí –∑–∞–ø–∏—Å–∞—Ç—å—Å—è ‚Üí –æ—Ç–º–µ–Ω–∏—Ç—å ‚Üí –∑–∞–ø–∏—Å–∞—Ç—å—Å—è —Å–Ω–æ–≤–∞
–î–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –æ—à–∏–±–æ–∫! ‚úÖ
```

---

**Fix –≥–æ—Ç–æ–≤!** üéØ –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ –Ω–∞ —Ç–æ—Ç –∂–µ —Å–ª–æ—Ç –ø–æ—Å–ª–µ –æ—Ç–º–µ–Ω—ã! üöÄ

